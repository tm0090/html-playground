<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Progress Tracker</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#7dd3fc; --accent-2:#60a5fa; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,var(--bg),#061122);color:#e6eef6;min-height:100vh;display:flex;flex-direction:column;}
.container{max-width:980px;margin:0 auto;flex:1;width:100%;padding: 24px;}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
.header h1{font-size:20px;margin:0}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;cursor:pointer;transition:all 0.15s ease;}
.btn:hover{background:rgba(255,255,255,0.06);transform:translateY(-1px);}
.btn.strong{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#022; font-weight:700}
.btn.strong:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(125, 211, 252, 0.2);}
.overview{display:flex;gap:12px;align-items:center;margin-bottom:18px;flex-wrap:wrap;}
.progress-big{flex:1;background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;min-width:280px;}
.progress-row{display:flex;align-items:center;gap:12px}
.progress-bar{height:12px;background:rgba(255,255,255,0.04);border-radius:999px;flex:1;overflow:hidden;position:relative}
.progress-bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%;transition:width 0.3s ease;}
.small{font-size:13px;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;width:100%;}
.card{background:var(--card);padding:12px;border-radius:12px;min-height:120px;width:100%;
    transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.2s cubic-bezier(0.2, 0, 0, 1);
}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.2);}
.card h3{margin:0 0 8px 0;font-size:16px;cursor:grab;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.chapters{display:flex;flex-direction:column;gap:6px;overflow:auto;padding-right:6px;width:100%;transition: max-height 0.3s ease;}
.chapter{display:flex;align-items:flex-start;gap:8px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px; position: relative; width:100%; flex-direction:column;
    transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), background-color 0.2s cubic-bezier(0.2, 0, 0, 1);
}
.chapter:hover{background:rgba(255,255,255,0.04);transform:translateX(4px);}
.chapter .drag-handle { cursor: grab; padding: 4px; transition: color 0.15s ease, transform 0.15s ease; flex-shrink:0; touch-action: none; }
.chapter .drag-handle:hover { color: var(--accent); transform: scale(1.1); }
.subject-card .drag-handle { cursor: grab; padding: 6px; transition: color 0.15s ease, transform 0.15s ease; flex-shrink:0; touch-action: none; }
.subject-card .drag-handle:hover { color: var(--accent); transform: scale(1.1); }
.subject-card.dragging{opacity: 0.9; transform: rotate(2deg) scale(1.03); box-shadow: 0 15px 30px rgba(0,0,0,0.4); z-index: 1000; filter: brightness(1.1);}
.chapter.dragging{opacity: 0.9; transform: rotate(1deg) scale(1.02); box-shadow: 0 6px 16px rgba(0,0,0,0.3); z-index: 1000; filter: brightness(1.1);}
.drag-placeholder{opacity:0.2; border:2px dashed var(--accent); border-radius:10px; background:var(--glass); animation: pulse 1s infinite;flex-shrink:0;}
.add-row{display:flex;gap:6px;margin-top:8px;width:100%;flex-wrap:wrap;}
.input, .select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:inherit;outline:none;transition:border 0.15s ease;flex:1;min-width:120px;}
.input:focus, .select:focus{border-color:var(--accent);}
.footer{margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;width:100%;}
.smallnote{color:var(--muted);font-size:13px}
.actions{display:flex;gap:8px;flex-wrap:wrap;}
.importfile{display:none}
.switch{display:inline-flex;align-items:center;gap:6px}
.dark-toggle{cursor:pointer;padding:6px;border-radius:8px}
.empty{opacity:0.6;color:var(--muted);padding:18px;text-align:center}
.devnote{text-align:center;font-size:12px;color:var(--muted);margin-top:18px;}
.item-menu {
  display: none; position: absolute; right: 0; top: 36px; background-color: #1a273b; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 4px; z-index: 10; min-width: 120px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideDown 0.15s ease-out;
}
.item-menu.active { display: block; }
.menu-option {
  display: block; width: 100%; background: none; border: none; color: inherit; font-family: inherit; padding: 8px 10px; text-align: left; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.15s ease;
}
.menu-option:hover { background: rgba(255,255,255,0.05); }
.menu-option.delete { color: #fca5a5; }

.drag-ghost {
  position: fixed; pointer-events: none; z-index: 10000; opacity: 0.9;
  will-change: transform;
  transition: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4); border-radius: 10px;
  filter: brightness(1.1) saturate(1.2);
  transform-origin: center;
}
.drag-over {
  background: rgba(125, 211, 252, 0.1); border: 1px dashed var(--accent); transform: scale(1.01); transition: all 0.1s ease;
}
.drag-handle:active, .subject-card h3:active { cursor: grabbing; }
.drag-success { animation: bounce 0.4s ease; }
.drag-icon { display: inline-block; font-size: 16px; color: var(--muted); transition: all 0.15s ease; }
.drag-handle:hover .drag-icon { color: var(--accent); transform: scale(1.2); }
.chapter-content { display: flex; align-items: center; gap: 8px; width: 100%; min-width: 0; cursor: pointer; }
.chapter-label { flex: 1; min-width: 0; white-space: normal; font-weight: bold; }
.subject-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; width: 100%; }
.subject-title-container { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; flex: 1; min-width: 0; cursor: pointer; }
.subject-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 16px; font-weight: bold; }
.subject-stats { font-size: 13px; color: var(--muted); }
.subject-actions { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }

.topics {display:flex; flex-direction:column; gap:6px; margin-top:6px; padding-right:6px; overflow: auto; transition: max-height 0.3s ease; width: 100%; }
.topic {display:flex; align-items:center; gap:6px; background:rgba(255,255,255,0.02); padding:6px; border-radius:6px; position: relative; width:100%;
    transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), background-color 0.2s cubic-bezier(0.2, 0, 0, 1);
}
.topic:hover {background:rgba(255,255,255,0.04);transform:translateX(2px);}
.topic .drag-handle { cursor: grab; padding: 3px; transition: color 0.15s ease, transform 0.15s ease; flex-shrink:0; touch-action: none; }
.topic .drag-handle:hover { color: var(--accent); transform: scale(1.1); }
.topic.dragging{opacity: 0.9; transform: rotate(1deg) scale(1.02); box-shadow: 0 6px 16px rgba(0,0,0,0.3); z-index: 1000; filter: brightness(1.1);}
.topic input[type=checkbox]{width:14px;height:14px;flex-shrink:0;}
.topic-content { display: flex; align-items: center; gap: 6px; width: 100%; min-width: 0; }
.topic-label { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.small-progress-row { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.small-progress { height: 8px; width: 50px; border-radius: 999px; flex-shrink: 0; }
.small-pct { min-width: 30px; text-align: right; font-size: 12px; flex-shrink: 0; }

@keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 0.4; } 100% { opacity: 0.2; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }
@keyframes sparkle {
  0% { opacity: 0; transform: scale(0.2) translate(0, 8px) rotate(0deg); }
  20% { opacity: 1; transform: scale(2) translate(3px, -8px) rotate(45deg); }
  40% { opacity: 0.8; transform: scale(1.2) translate(6px, -4px) rotate(90deg); }
  60% { opacity: 1; transform: scale(2.5) translate(9px, -8px) rotate(135deg); }
  80% { opacity: 0.7; transform: scale(1.5) translate(12px, -4px) rotate(180deg); }
  100% { opacity: 0; transform: scale(0.2) translate(15px, 0) rotate(225deg); }
}
@keyframes move-across {
  0% { left: -10%; }
  100% { left: 110%; }
}

.no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
.touch-dragging { transition: none !important; }

@media (min-width: 1280px) {
  .container {
    max-width: 1280px;
  }
  .grid {
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  }
}

@media (max-width: 768px) {
  .container { padding: 12px; }
  .grid { grid-template-columns: 1fr; }
  .header { flex-direction: column; align-items: flex-start; gap: 12px; }
  .controls { width: 100%; justify-content: space-between; }
  .progress-big { min-width: 100%; }
  .footer { flex-direction: column; gap: 12px; }
  .actions { justify-content: center; width: 100%; }
  .drag-handle { padding: 8px; }
  .btn { padding: 10px 12px; min-height: 44px; }
  .item-menu { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 280px; }
  
  /* Fix for topics on mobile */
  .topics {
    margin-left: 0;
  }
  .topic-content {
    flex-wrap: wrap;
  }
  .topic-label {
    flex: 1;
    min-width: 120px;
  }
  .chapter-content {
    flex-wrap: wrap;
    gap: 4px;
  }
  .chapter-label {
    min-width: 100%;
    margin-bottom: 4px;
  }
  .small-progress-row {
    margin-left: 0;
    width: 100%;
    justify-content: flex-end;
  }
  .add-row {
    margin-left: 0;
  }
  .progress-row {
    width: 100%;
  }
  .subj-pct-container, .total-pct-container {
    flex-shrink: 0;
  }
}
@media (max-width: 560px){
  .header{flex-direction:column;align-items:flex-start;gap:8px}
  .controls{flex-direction:column;align-items:flex-start;width:100%;}
  .btn { width: 100%; }
  .subject-header { flex-direction: column; align-items: flex-start; }
  .subject-actions { width: 100%; justify-content: space-between; }
  .chapter-content { flex-wrap: wrap; }
  .chapter-label { min-width: 100px; }
  
  /* Additional mobile fixes for topics */
  .topics {
    margin-left: 0;
  }
  .topic {
    padding: 8px;
  }
  .topic-content {
    gap: 4px;
  }
  .topic-label {
    font-size: 14px;
  }
}

/* Differentiate main progress bar */
.overview .progress-bar {
  height: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Main progress bar sparkle effect */
#totalFill {
  position: relative;
  overflow: hidden;
}
#totalFill::before,
#totalFill::after,
#totalFill .extra-sparkle,
#totalFill .extra-sparkle2 {
  content: '';
  position: absolute;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
  animation: sparkle 1.5s infinite ease-in-out, move-across 5s infinite linear;
  pointer-events: none;
}
#totalFill::before {
  top: 50%;
  animation-delay: -0.2s, -0.2s;
}
#totalFill::after {
  top: 50%;
  animation-delay: -0.8s, -1.5s;
}
#totalFill .extra-sparkle {
  top: 50%;
  width: 10px;
  height: 10px;
  animation-delay: -1.2s, -3s;
}
#totalFill .extra-sparkle2 {
  top: 50%;
  width: 6px;
  height: 6px;
  animation-delay: -0.5s, -4s;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Study Progress Tracker</h1>
    <div class="controls">
      <button class="btn" id="exportBtn">Export JSON</button>
      <label class="btn" for="import">Import JSON</label>
      <input id="import" class="importfile" type="file" accept="application/json">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn strong" id="addSubjectBtn">+ Add Subject</button>
    </div>
  </div>

  <div class="overview">
    <div class="progress-big">
      <div class="progress-row">
        <div style="flex:1">
          <div class="small">Total progress</div>
          <div style="display:flex;align-items:center;gap:12px;margin-top:6px">
            <div class="progress-bar" aria-hidden><i id="totalFill"></i></div>
            <div class="total-pct-container" style="min-width:58px;text-align:right;flex-shrink:0"><strong id="totalPct">0%</strong></div>
          </div>
          <div class="small smallnote" style="margin-top:8px">Shows combined completion across all subjects, chapters & topics.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid" id="subjectsGrid"></div>

  <div class="footer">
    <div class="smallnote">Tip: Add subjects, chapters, and topics to organize your study plan. Check off completed chapters and topics to track progress. Double-tap or double-click to collapse/expand subjects and chapters for a cleaner view. Drag to reorder items. ⚠️ Data is saved locally in your browser.</div>
    <div style="flex:1"></div>
    <div class="actions">
      <button class="btn" id="importSample">Load Example</button>
      <button class="btn" id="shareBtn">Copy Shareable JSON</button>
    </div>
  </div>
</div>
<div class="devnote">Made with ❤️ by Tamim </div>

<template id="subjectTpl">
  <div class="card subject-card">
    <div class="subject-header">
      <div class="subject-title-container">
        <h3 class="subj-title no-select">
          <span class="drag-handle">
            <span class="drag-icon">☰</span>
          </span>
          <span class="subject-name">Subject</span>
        </h3>
      </div>
      <div class="subject-actions">
        
        <button class="btn editSubj">Edit</button>
        <button class="btn delSubj">Delete</button>
      </div>
    </div>
    <div class="small" style="margin:8px 0 6px 0">Progress</div>
    <div class="progress-row">
      <div class="progress-bar"><i class="subjFill"></i></div>
      <div class="subj-pct-container" style="min-width:58px;text-align:right;flex-shrink:0"><strong class="subjPct">0%</strong></div>
    </div>
    <div class="chapters"></div>
    <div class="add-row">
      <input class="input chapterName" placeholder="New chapter name">
      <button class="btn addChapter">Add</button>
    </div>
  </div>
</template>

<script>
const KEY = 'study-progress-v1';
const BACKUP_KEY = 'study-progress-backup';
let state = { subjects: [] };
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));

function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function load(){ const raw = localStorage.getItem(KEY); if(raw) try{ state = JSON.parse(raw); }catch(e){ state={subjects:[]} } }
function uid(){return Math.random().toString(36).slice(2,9)}
function closeAllMenus() { $$('.item-menu').forEach(menu => menu.classList.remove('active')); }

function computeChapterProgress(ch) {
  let total = 0;
  let done = 0;
  if (ch.topics && ch.topics.length > 0) {
    total = ch.topics.length;
    done = ch.topics.filter(t => t.done).length;
  } else {
    total = 1;
    done = ch.done ? 1 : 0;
  }
  const pct = total === 0 ? 0 : Math.round(done / total * 100);
  return {total, done, pct};
}

function computeSubjectProgress(subject) {
  let total = 0;
  let done = 0;
  for (const ch of subject.chapters) {
    const chStats = computeChapterProgress(ch);
    total += chStats.total;
    done += chStats.done;
  }
  const pct = total === 0 ? 0 : Math.round(done / total * 100);
  return {total, done, pct};
}

class DragManager {
  constructor() {
    this.draggingElement = null;
    this.dragGhost = null;
    this.placeholder = null;
    this.dragType = null;
    this.isTouchDevice = 'ontouchstart' in window;
    this.init();
  }

  init() {
    document.addEventListener('mousemove', this.handleMouseMove.bind(this));
    document.addEventListener('mouseup', this.handleMouseUp.bind(this));
    document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
    document.addEventListener('touchend', this.handleTouchEnd.bind(this));
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.item-menu') && !e.target.matches('.chapter-menu-btn')) {
        closeAllMenus();
      }
    });
  }

  startDrag(element, type, event) {
    if (this.draggingElement) return;
    closeAllMenus();
    this.draggingElement = element;
    this.dragType = type;
    
    this.createDragGhost(element);
    
    this.placeholder = document.createElement('div');
    this.placeholder.className = 'drag-placeholder';
    this.placeholder.style.height = element.offsetHeight + 'px';
    this.placeholder.style.width = element.offsetWidth + 'px';
    
    element.parentNode.insertBefore(this.placeholder, element);
    element.classList.add('dragging');
    
    if (this.isTouchDevice) {
      element.classList.add('touch-dragging');
    }
    
    this.currentContainer = element.parentNode;
    
    this.updateGhostPosition(event);
    
    event.preventDefault();
  }

  createDragGhost(element) {
    this.dragGhost = element.cloneNode(true);
    this.dragGhost.classList.add('drag-ghost');
    this.dragGhost.style.width = element.offsetWidth + 'px';
    this.dragGhost.style.height = element.offsetHeight + 'px';
    this.dragGhost.style.background = 'var(--card)';
    this.dragGhost.style.border = '1px solid var(--accent)';
    this.dragGhost.style.backdropFilter = 'blur(5px)';
    
    // Remove any interactive elements from the ghost
    const interactiveElements = this.dragGhost.querySelectorAll('button, input, .drag-handle, .item-menu');
    interactiveElements.forEach(el => el.remove());
    
    document.body.appendChild(this.dragGhost);
  }

  updateGhostPosition(event) {
    if (!this.dragGhost || !this.draggingElement) return;
    
    const clientX = event.clientX || (event.touches && event.touches[0].clientX);
    const clientY = event.clientY || (event.touches && event.touches[0].clientY);
    
    if (clientX !== undefined && clientY !== undefined) {
        const x = clientX - this.dragGhost.offsetWidth / 2;
        const y = clientY - this.dragGhost.offsetHeight / 2;
        this.dragGhost.style.transform = `translate(${x}px, ${y}px)`;
    }
    
    this.updateDropZone();
  }

  updateDropZone() {
    if (!this.draggingElement || !this.placeholder) return;
    
    const container = this.currentContainer;
    const siblings = Array.from(container.children)
      .filter(child => child !== this.draggingElement && child !== this.placeholder);
    
    siblings.forEach(sib => sib.classList.remove('drag-over'));
    
    if (siblings.length === 0) {
      if (container.children[0] !== this.placeholder) {
        container.insertBefore(this.placeholder, container.children[0]);
      }
      return;
    }
    
    const ghostRect = this.dragGhost.getBoundingClientRect();
    let closestSibling = null;
    let minDistance = Infinity;
    
    siblings.forEach(sibling => {
      const siblingRect = sibling.getBoundingClientRect();
      let distance;
      
      if (container.classList.contains('chapters') || container.classList.contains('topics')) {
        // For vertical lists, use vertical distance only
        distance = Math.abs(ghostRect.top - siblingRect.top);
      } else {
        // For grid layouts, use Euclidean distance
        distance = Math.hypot(ghostRect.left - siblingRect.left, ghostRect.top - siblingRect.top);
      }
      
      if (distance < minDistance) {
        minDistance = distance;
        closestSibling = sibling;
      }
    });
    
    if (closestSibling) {
      const siblingRect = closestSibling.getBoundingClientRect();
      let insertBefore = false;
      
      if (container.classList.contains('chapters') || container.classList.contains('topics')) {
        // For vertical lists, check if we're above the middle of the sibling
        insertBefore = ghostRect.top < siblingRect.top + siblingRect.height / 2;
      } else {
        // For grid layouts, check if we're to the left of the middle of the sibling
        insertBefore = ghostRect.left < siblingRect.left + siblingRect.width / 2;
      }
      
      closestSibling.classList.add('drag-over');
      
      if (insertBefore) {
        if (closestSibling.previousSibling !== this.placeholder) {
          container.insertBefore(this.placeholder, closestSibling);
        }
      } else {
        if (closestSibling.nextSibling !== this.placeholder) {
          container.insertBefore(this.placeholder, closestSibling.nextSibling);
        }
      }
    }
  }

  endDrag() {
    if (!this.draggingElement || !this.placeholder) return;
    
    $$('.drag-over').forEach(el => el.classList.remove('drag-over'));
    this.currentContainer.insertBefore(this.draggingElement, this.placeholder);
    
    this.draggingElement.classList.add('drag-success');
    setTimeout(() => {
        if (this.draggingElement) this.draggingElement.classList.remove('drag-success');
    }, 400);
    
    this.draggingElement.classList.remove('dragging', 'touch-dragging');
    this.placeholder.remove();
    if (this.dragGhost) {
      this.dragGhost.remove();
      this.dragGhost = null;
    }
    
    this.updateState();
    
    this.draggingElement = null;
    this.placeholder = null;
    this.dragType = null;
    this.currentContainer = null;
  }

  updateState() {
    if (this.dragType === 'subject') {
      state.subjects = Array.from($('#subjectsGrid').children)
        .filter(c => c.classList.contains('subject-card'))
        .map(c => state.subjects.find(s => s.id === c.dataset.id));
    } else if (this.dragType === 'chapter') {
      const subjectId = this.currentContainer.closest('.subject-card').dataset.id;
      const subject = state.subjects.find(s => s.id === subjectId);
      if (subject) {
        subject.chapters = Array.from(this.currentContainer.children)
          .filter(c => c.classList.contains('chapter'))
          .map(r => subject.chapters.find(ch => ch.id === r.dataset.id));
      }
    } else if (this.dragType === 'topic') {
      const chapterElement = this.currentContainer.closest('.chapter');
      const subjectId = chapterElement.closest('.subject-card').dataset.id;
      const chapterId = chapterElement.dataset.id;
      const subject = state.subjects.find(s => s.id === subjectId);
      if (subject) {
        const chapter = subject.chapters.find(c => c.id === chapterId);
        if (chapter) {
          chapter.topics = Array.from(this.currentContainer.children)
            .filter(c => c.classList.contains('topic'))
            .map(r => chapter.topics.find(t => t.id === r.dataset.id));
        }
      }
    }
    save();
    render();
  }

  handleMouseMove(event) {
    if (this.draggingElement) { 
      this.updateGhostPosition(event); 
    }
  }
  
  handleMouseUp() {
    if (this.draggingElement) { 
      this.endDrag(); 
    }
  }
  
  handleTouchMove(event) {
    if (this.draggingElement) {
      this.updateGhostPosition(event);
      event.preventDefault();
    }
  }
  
  handleTouchEnd() {
    if (this.draggingElement) { 
      this.endDrag(); 
    }
  }
}

const dragManager = new DragManager();

function makeDraggable(element, type, handleSelector) {
  const handle = handleSelector ? element.querySelector(handleSelector) : element;
  if (!handle) return;
  
  // Mouse events
  handle.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return; // Only left mouse button
    dragManager.startDrag(element, type, e);
  });
  
  // Touch events with improved long press detection
  let touchTimer;
  let longPressTriggered = false;
  
  handle.addEventListener('touchstart', (e) => {
    longPressTriggered = false;
    touchTimer = setTimeout(() => {
      longPressTriggered = true;
      dragManager.startDrag(element, type, e);
    }, 300); // Reduced time for better responsiveness
  });
  
  const cancelLongPress = () => {
    clearTimeout(touchTimer);
  };
  
  handle.addEventListener('touchend', cancelLongPress);
  handle.addEventListener('touchmove', (e) => {
    if (!longPressTriggered) {
      cancelLongPress();
    } else {
      // If we're already dragging, update position
      dragManager.updateGhostPosition(e);
    }
  });

  // Prevent context menu on long press
  handle.addEventListener('contextmenu', (e) => e.preventDefault());
  handle.classList.add('no-select');
}

function getProgressColors(pct) {
  if (pct < 30) {
    return {color1: '#ef4444', color2: '#b91c1c'};
  } else if (pct < 75) {
    return {color1: '#eab308', color2: '#a16207'};
  } else {
    return {color1: '#22c55e', color2: '#15803d'};
  }
}

function render(){
  const grid = $('#subjectsGrid');
  grid.innerHTML = '';
  
  let totTotal = 0, totDone = 0;
  const isMobile = window.matchMedia("(max-width: 768px)").matches;
  const expandedHeight = isMobile ? '300px' : '500px';
  for (const subj of state.subjects) {
    if (!('expanded' in subj)) subj.expanded = true;
    const stats = computeSubjectProgress(subj);
    totTotal += stats.total;
    totDone += stats.done;
    
    const tpl = document.getElementById('subjectTpl');
    const el = tpl.content.firstElementChild.cloneNode(true);
    el.dataset.id = subj.id;
    el.querySelector('.subject-name').textContent = subj.name;
    
    const chTotal = subj.chapters.length;
    const chDone = subj.chapters.filter(c => c.done).length;
    const statsDiv = document.createElement('div');
    statsDiv.className = 'subject-stats';
    statsDiv.textContent = `Chapters: ${chDone}/${chTotal} | Topics: ${stats.done}/${stats.total}`;
    el.querySelector('.subject-title-container').appendChild(statsDiv);
    
    const subjFill = el.querySelector('.subjFill');
    subjFill.style.width = stats.pct + '%';
    const subjColors = getProgressColors(stats.pct);
    subjFill.style.background = `linear-gradient(90deg, ${subjColors.color1}, ${subjColors.color2})`;
    el.querySelector('.subjPct').textContent = stats.pct + '%';
    
    const chapContainer = el.querySelector('.chapters');
    chapContainer.style.maxHeight = subj.expanded ? expandedHeight : '0px';
    const addChapterRow = el.querySelector('.add-row');
    addChapterRow.style.display = subj.expanded ? 'flex' : 'none';
    
    if (subj.chapters.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'empty';
      empty.textContent = 'No chapters yet.';
      chapContainer.appendChild(empty);
    } else {
      subj.chapters.forEach(ch => {
        if (!('expanded' in ch)) ch.expanded = true;
        const row = document.createElement('div');
        row.className = 'chapter';
        row.dataset.id = ch.id;
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!ch.done;
        cb.addEventListener('change', () => {
          ch.done = cb.checked;
          if (ch.topics) {
            ch.topics.forEach(t => t.done = ch.done);
          }
          save();
          render();
        });
        
        const label = document.createElement('div');
        label.className = 'chapter-label';
        label.textContent = ch.name;
        
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = '<span class="drag-icon">⋮⋮</span>';
        dragHandle.title = 'Drag to reorder';
        
        const actionsBtn = document.createElement('button');
        actionsBtn.className = 'btn chapter-menu-btn';
        actionsBtn.textContent = '⋯';
        actionsBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const menu = row.querySelector('.item-menu');
          const isActive = menu.classList.contains('active');
          closeAllMenus();
          if (!isActive) {
            menu.classList.add('active');
          }
        });
        
        const menu = document.createElement('div');
        menu.className = 'item-menu';
        
        const editOption = document.createElement('button');
        editOption.className = 'menu-option';
        editOption.textContent = 'Edit';
        editOption.addEventListener('click', () => {
          const n = prompt('Edit chapter name:', ch.name);
          if (n && n.trim() !== '' && n.trim() !== ch.name) {
            ch.name = n.trim();
            save();
            render();
          }
          closeAllMenus();
        });
        
        const deleteOption = document.createElement('button');
        deleteOption.className = 'menu-option delete';
        deleteOption.textContent = 'Delete';
        deleteOption.addEventListener('click', () => {
          if (confirm('Delete chapter "' + ch.name + '"?')) {
            subj.chapters = subj.chapters.filter(x => x.id !== ch.id);
            save();
            render();
          }
          closeAllMenus();
        });
        
        menu.appendChild(editOption);
        menu.appendChild(deleteOption);
        
        const chStats = computeChapterProgress(ch);
        const chapProgressRow = document.createElement('div');
        chapProgressRow.className = 'small-progress-row';
        const chapProgress = document.createElement('div');
        chapProgress.className = 'progress-bar small-progress';
        const chapFill = document.createElement('i');
        chapFill.style.width = chStats.pct + '%';
        const chColors = getProgressColors(chStats.pct);
        chapFill.style.background = `linear-gradient(90deg, ${chColors.color1}, ${chColors.color2})`;
        chapProgress.appendChild(chapFill);
        const chapPct = document.createElement('div');
        chapPct.className = 'small-pct';
        chapPct.textContent = chStats.pct + '%';
        chapProgressRow.appendChild(chapProgress);
        chapProgressRow.appendChild(chapPct);
        
        const chapterContent = document.createElement('div');
        chapterContent.className = 'chapter-content';
        chapterContent.appendChild(cb);
        chapterContent.appendChild(dragHandle);
        chapterContent.appendChild(label);
        chapterContent.appendChild(chapProgressRow);
        chapterContent.appendChild(actionsBtn);
        
        row.appendChild(chapterContent);
        row.appendChild(menu);
        
        const topicsContainer = document.createElement('div');
        topicsContainer.className = 'topics';
        topicsContainer.style.maxHeight = ch.expanded ? expandedHeight : '0px';
        row.appendChild(topicsContainer);
        
        if (!ch.topics) ch.topics = [];
        if (ch.topics.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.style.padding = '8px';
          empty.textContent = 'No topics yet.';
          topicsContainer.appendChild(empty);
        } else {
          ch.topics.forEach(t => {
            const topicRow = document.createElement('div');
            topicRow.className = 'topic';
            topicRow.dataset.id = t.id;
            
            const topicCb = document.createElement('input');
            topicCb.type = 'checkbox';
            topicCb.checked = !!t.done;
            topicCb.addEventListener('change', () => {
              t.done = topicCb.checked;
              save();
              render();
            });
            
            const topicLabel = document.createElement('div');
            topicLabel.className = 'topic-label';
            topicLabel.textContent = t.name;
            
            const topicDragHandle = document.createElement('div');
            topicDragHandle.className = 'drag-handle';
            topicDragHandle.innerHTML = '<span class="drag-icon">⋮⋮</span>';
            topicDragHandle.title = 'Drag to reorder';
            
            const topicActionsBtn = document.createElement('button');
            topicActionsBtn.className = 'btn chapter-menu-btn';
            topicActionsBtn.textContent = '⋯';
            topicActionsBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const topicMenu = topicRow.querySelector('.item-menu');
              const isActive = topicMenu.classList.contains('active');
              closeAllMenus();
              if (!isActive) {
                topicMenu.classList.add('active');
              }
            });
            
            const topicMenu = document.createElement('div');
            topicMenu.className = 'item-menu';
            
            const topicEditOption = document.createElement('button');
            topicEditOption.className = 'menu-option';
            topicEditOption.textContent = 'Edit';
            topicEditOption.addEventListener('click', () => {
              const n = prompt('Edit topic name:', t.name);
              if (n && n.trim() !== '' && n.trim() !== t.name) {
                t.name = n.trim();
                save();
                render();
              }
              closeAllMenus();
            });
            
            const topicDeleteOption = document.createElement('button');
            topicDeleteOption.className = 'menu-option delete';
            topicDeleteOption.textContent = 'Delete';
            topicDeleteOption.addEventListener('click', () => {
              if (confirm('Delete topic "' + t.name + '"?')) {
                ch.topics = ch.topics.filter(x => x.id !== t.id);
                save();
                render();
              }
              closeAllMenus();
            });
            
            topicMenu.appendChild(topicEditOption);
            topicMenu.appendChild(topicDeleteOption);
            
            const topicContent = document.createElement('div');
            topicContent.className = 'topic-content';
            topicContent.appendChild(topicCb);
            topicContent.appendChild(topicDragHandle);
            topicContent.appendChild(topicLabel);
            topicContent.appendChild(topicActionsBtn);
            
            topicRow.appendChild(topicContent);
            topicRow.appendChild(topicMenu);
            topicsContainer.appendChild(topicRow);
            makeDraggable(topicRow, 'topic', '.drag-handle');
          });
        }
        
        const addTopicRow = document.createElement('div');
        addTopicRow.className = 'add-row';
        addTopicRow.style.marginTop = '6px';
        addTopicRow.style.display = ch.expanded ? 'flex' : 'none';
        const topicInput = document.createElement('input');
        topicInput.className = 'input topicName';
        topicInput.placeholder = 'New topic name';
        const addTopicBtn = document.createElement('button');
        addTopicBtn.className = 'btn addTopic';
        addTopicBtn.textContent = 'Add';
        addTopicBtn.addEventListener('click', () => {
          const val = topicInput.value.trim();
          if (!val) return;
          ch.topics.push({id: uid(), name: val, done: false});
          topicInput.value = '';
          save();
          render();
        });
        addTopicRow.appendChild(topicInput);
        addTopicRow.appendChild(addTopicBtn);
        row.appendChild(addTopicRow);
        
        chapterContent.addEventListener('dblclick', () => {
          ch.expanded = !ch.expanded;
          topicsContainer.style.maxHeight = ch.expanded ? expandedHeight : '0px';
          addTopicRow.style.display = ch.expanded ? 'flex' : 'none';
          save();
        });
        
        let lastTapChapter = 0;
        chapterContent.addEventListener('touchend', (e) => {
          if (dragManager.draggingElement) return;
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('.drag-handle')) return;
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTapChapter;
          if (tapLength < 500 && tapLength > 0) {
            ch.expanded = !ch.expanded;
            topicsContainer.style.maxHeight = ch.expanded ? expandedHeight : '0px';
            addTopicRow.style.display = ch.expanded ? 'flex' : 'none';
            save();
            e.preventDefault();
          }
          lastTapChapter = currentTime;
        });
        
        chapContainer.appendChild(row);
        makeDraggable(row, 'chapter', '.drag-handle');
      });
    }

    el.querySelector('.addChapter').addEventListener('click', () => {
      const val = el.querySelector('.chapterName').value.trim();
      if (!val) return;
      subj.chapters.push({id: uid(), name: val, done: false, topics: [], expanded: true});
      el.querySelector('.chapterName').value = '';
      save();
      render();
    });
    
    el.querySelector('.editSubj').addEventListener('click', () => {
      const n = prompt('Rename subject', subj.name);
      if (!n) return;
      subj.name = n.trim();
      save();
      render();
    });
    
    el.querySelector('.delSubj').addEventListener('click', () => {
      if (confirm('Delete subject "' + subj.name + '" and its chapters?')) {
        state.subjects = state.subjects.filter(s => s.id !== subj.id);
        save();
        render();
      }
    });

    const subjectTitleContainer = el.querySelector('.subject-title-container');
    subjectTitleContainer.addEventListener('dblclick', () => {
      subj.expanded = !subj.expanded;
      chapContainer.style.maxHeight = subj.expanded ? expandedHeight : '0px';
      addChapterRow.style.display = subj.expanded ? 'flex' : 'none';
      save();
    });

    let lastTapSubject = 0;
    subjectTitleContainer.addEventListener('touchend', (e) => {
      if (dragManager.draggingElement) return;
      if (e.target.closest('.drag-handle')) return;
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTapSubject;
      if (tapLength < 500 && tapLength > 0) {
        subj.expanded = !subj.expanded;
        chapContainer.style.maxHeight = subj.expanded ? expandedHeight : '0px';
        addChapterRow.style.display = subj.expanded ? 'flex' : 'none';
        save();
        e.preventDefault();
      }
      lastTapSubject = currentTime;
    });
    
    grid.appendChild(el);
    makeDraggable(el, 'subject', '.drag-handle');
  }
  
  const totalPct = (totTotal === 0 ? 0 : Math.round(totDone / totTotal * 100));
  const totalFill = $('#totalFill');
  totalFill.style.width = totalPct + '%';
  const totalColors = getProgressColors(totalPct);
  totalFill.style.background = `linear-gradient(90deg, ${totalColors.color1}, ${totalColors.color2})`;
  $('#totalPct').textContent = totalPct + '%';
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.item-menu, .chapter-menu-btn')) {
        closeAllMenus();
    }
});
$('#addSubjectBtn').addEventListener('click', () => {
  const n = prompt('Subject name (e.g. Physics)');
  if (!n) return;
  state.subjects.push({id: uid(), name: n.trim(), chapters: [], expanded: true});
  save();
  render();
});
$('#resetBtn').addEventListener('click', () => {
  if (confirm('Clear all saved data?')) {
    state = {subjects: []};
    save();
    sessionStorage.removeItem(BACKUP_KEY);
    $('#importSample').textContent = 'Load Example';
    render();
  }
});
$('#exportBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'study-progress.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
});
$('#import').addEventListener('change', ev => {
  const f = ev.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = e => {
    try {
      const imp = JSON.parse(e.target.result);
      if (imp && Array.isArray(imp.subjects)) {
        state = imp;
        save();
        render();
        alert('Imported successfully');
      } else alert('Invalid file format');
    } catch (err) {
      alert('Invalid JSON');
    }
  };
  r.readAsText(f);
  ev.target.value = '';
});
$('#importSample').addEventListener('click', e => {
  const btn = e.target;
  const backup = sessionStorage.getItem(BACKUP_KEY);
  if (backup) {
    state = JSON.parse(backup);
    sessionStorage.removeItem(BACKUP_KEY);
    btn.textContent = 'Load Example';
  } else {
    sessionStorage.setItem(BACKUP_KEY, JSON.stringify(state));
    const sample = { subjects: [
      {id: uid(), name: 'Physics (Sample)', chapters: [
        {id: uid(), name: 'Kinematics', done: true, topics: [{id: uid(), name: '1D Motion', done: true}, {id: uid(), name: '2D Motion', done: false}], expanded: true},
        {id: uid(), name: 'Dynamics', done: false, topics: [{id: uid(), name: "Newton's Laws", done: false}, {id: uid(), name: 'Friction', done: false}], expanded: true},
        {id: uid(), name: 'Work & Energy', done: false, topics: [], expanded: true}
      ], expanded: true},
      {id: uid(), name: 'Chemistry (Sample)', chapters: [
        {id: uid(), name: 'Atomic Structure', done: true, topics: [{id: uid(), name: 'Bohr Model', done: true}], expanded: true},
        {id: uid(), name: 'Periodic Table', done: true, topics: [{id: uid(), name: 'Groups', done: true}, {id: uid(), name: 'Periods', done: false}], expanded: true}
      ], expanded: true},
      {id: uid(), name: 'Math (Sample)', chapters: [
        {id: uid(), name: 'Limits', done: false, topics: [], expanded: true},
        {id: uid(), name: 'Derivatives', done: false, topics: [{id: uid(), name: 'Chain Rule', done: false}], expanded: true}
      ], expanded: true}
    ]};
    state = sample;
    btn.textContent = 'Unload Example';
  }
  save();
  render();
});
$('#shareBtn').addEventListener('click', () => {
  navigator.clipboard.writeText(JSON.stringify(state)).then(() => alert('Copied JSON to clipboard — share it or paste in Import.'));
});

load();
render();
if (sessionStorage.getItem(BACKUP_KEY)) $('#importSample').textContent = 'Unload Example';
setInterval(save, 10);
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    save();
  }
});
</script>
</body>
</html>
